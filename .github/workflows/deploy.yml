name: Deploy Discord Bot to Oracle Cloud

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œí•˜ë©´ ìë™ ë°°í¬
  workflow_dispatch:  # GitHubì—ì„œ ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  deploy:
    name: Deploy to Oracle Cloud
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ORACLE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to Oracle Cloud
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'ENDSSH'
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¤‘ë‹¨
            
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ì´ë™
            PROJECT_DIR="$HOME/discord-bot"
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "âŒ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤: $PROJECT_DIR"
              echo "ì´ˆê¸° ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:"
              echo "  mkdir -p $PROJECT_DIR"
              echo "  cd $PROJECT_DIR"
              echo "  git clone <your-repo-url> ."
              exit 1
            fi
            
            cd "$PROJECT_DIR"
            
            # ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ë°±ì—… (ë®ì–´ì“°ê¸° ë°©ì§€) - Git reset ì „ì— í•„ìˆ˜!
            DB_BACKUP_DIR="$PROJECT_DIR/db_backups"
            mkdir -p "$DB_BACKUP_DIR"
            
            if [ -f "bot_data.db" ]; then
              BACKUP_FILE="$DB_BACKUP_DIR/bot_data.db.backup.$(date +%Y%m%d_%H%M%S)"
              echo "ğŸ’¾ ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì¤‘: $BACKUP_FILE"
              cp bot_data.db "$BACKUP_FILE" || {
                echo "âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì‹¤íŒ¨, ë°°í¬ ì¤‘ë‹¨"
                exit 1
              }
              echo "âœ… ë°±ì—… ì™„ë£Œ: $(du -h "$BACKUP_FILE" | cut -f1)"
            else
              echo "â„¹ï¸ ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤ (ì‹ ê·œ ì„¤ì¹˜)"
            fi
            
            # Git pull (stashë¥¼ ì‚¬ìš©í•˜ì—¬ ì¶”ì ë˜ì§€ ì•ŠëŠ” íŒŒì¼ ë³´í˜¸)
            echo "ğŸ“¥ ì½”ë“œ ì—…ë°ì´íŠ¸ ì¤‘..."
            git fetch origin main
            
            # ì¶”ì ë˜ì§€ ì•ŠëŠ” íŒŒì¼ë“¤ì„ ì„ì‹œë¡œ stash (bot_data.db ë³´í˜¸)
            # git stashëŠ” ì¶”ì ë˜ì§€ ì•ŠëŠ” íŒŒì¼ë„ í¬í•¨í•  ìˆ˜ ìˆì§€ë§Œ, --include-untrackedëŠ” ì‹ ì¤‘í•˜ê²Œ ì‚¬ìš©
            # ëŒ€ì‹  bot_data.dbë¥¼ ì„ì‹œ ìœ„ì¹˜ë¡œ ì´ë™
            TEMP_DB="/tmp/bot_data.db.$$"
            if [ -f "bot_data.db" ]; then
              echo "ğŸ›¡ï¸ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ì„ì‹œ ë³´í˜¸ ì¤‘..."
              mv bot_data.db "$TEMP_DB" || {
                echo "âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ì´ë™ ì‹¤íŒ¨, ë°°í¬ ì¤‘ë‹¨"
                exit 1
              }
            fi
            
            # Git reset ì‹¤í–‰
            git reset --hard origin/main || {
              echo "âš ï¸ Git reset ì‹¤íŒ¨, ë°ì´í„°ë² ì´ìŠ¤ ë³µì› ì‹œë„..."
              if [ -f "$TEMP_DB" ]; then
                mv "$TEMP_DB" bot_data.db
              fi
              exit 1
            }
            
            # ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ë³µì›
            if [ -f "$TEMP_DB" ]; then
              echo "ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ë³µì› ì¤‘..."
              mv "$TEMP_DB" bot_data.db || {
                echo "âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë³µì› ì‹¤íŒ¨!"
                echo "ğŸ’¾ ë°±ì—…ì—ì„œ ë³µì› ì‹œë„..."
                LATEST_BACKUP=$(ls -t "$DB_BACKUP_DIR"/bot_data.db.backup.* 2>/dev/null | head -1)
                if [ -n "$LATEST_BACKUP" ]; then
                  cp "$LATEST_BACKUP" bot_data.db
                  echo "âœ… ë°±ì—…ì—ì„œ ë³µì› ì™„ë£Œ"
                else
                  echo "âŒ ë°±ì—… íŒŒì¼ë„ ì—†ìŠµë‹ˆë‹¤!"
                  exit 1
                fi
              }
              echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ë³µì› ì™„ë£Œ"
            fi
            
            # ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼ ì •ë¦¬ (30ì¼ ì´ìƒ ëœ ë°±ì—… ì‚­ì œ)
            echo "ğŸ§¹ ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼ ì •ë¦¬ ì¤‘..."
            find "$DB_BACKUP_DIR" -name "bot_data.db.backup.*" -mtime +30 -delete 2>/dev/null || true
            
            # ê°€ìƒí™˜ê²½ í™•ì¸ ë° ìƒì„±
            if [ ! -d "venv" ]; then
              echo "ğŸ“¦ ê°€ìƒí™˜ê²½ ìƒì„± ì¤‘..."
              python3 -m venv venv
            fi
            
            # ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            source venv/bin/activate
            pip install --upgrade pip --quiet
            pip install -r requirements.txt --quiet
            
            # ë´‡ ì¬ì‹œì‘
            echo "ğŸ”„ ë´‡ ì¬ì‹œì‘ ì¤‘..."
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ëª¨ë‘ ì¢…ë£Œ (systemdë“  ì§ì ‘ ì‹¤í–‰ì´ë“  ìƒê´€ì—†ì´)
            echo "ğŸ›‘ ê¸°ì¡´ ë´‡ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì¤‘..."
            
            # systemd ì„œë¹„ìŠ¤ê°€ ìˆìœ¼ë©´ ì¤‘ì§€
            if systemctl list-units --type=service --all | grep -q discord-bot; then
              sudo systemctl stop discord-bot 2>/dev/null || true
              echo "   systemd ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ"
            fi
            
            # ì§ì ‘ ì‹¤í–‰ëœ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            PIDS=$(pgrep -f "python.*main.py" 2>/dev/null || true)
            if [ -n "$PIDS" ]; then
              echo "   ì§ì ‘ ì‹¤í–‰ í”„ë¡œì„¸ìŠ¤ ë°œê²¬: $PIDS"
              echo "$PIDS" | xargs kill -TERM 2>/dev/null || true
              sleep 2
              # ê°•ì œ ì¢…ë£Œê°€ í•„ìš”í•œ ê²½ìš°
              REMAINING=$(pgrep -f "python.*main.py" 2>/dev/null || true)
              if [ -n "$REMAINING" ]; then
                echo "   ê°•ì œ ì¢…ë£Œ ì¤‘..."
                echo "$REMAINING" | xargs kill -9 2>/dev/null || true
                sleep 1
              fi
            fi
            
            # í”„ë¡œì„¸ìŠ¤ê°€ ì™„ì „íˆ ì¢…ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
            sleep 2
            REMAINING_PIDS=$(pgrep -f "python.*main.py" 2>/dev/null || true)
            if [ -n "$REMAINING_PIDS" ]; then
              echo "âš ï¸ ê²½ê³ : ì¼ë¶€ í”„ë¡œì„¸ìŠ¤ê°€ ì—¬ì „íˆ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤: $REMAINING_PIDS"
              echo "   ê°•ì œ ì¢…ë£Œ ì‹œë„..."
              echo "$REMAINING_PIDS" | xargs kill -9 2>/dev/null || true
              sleep 1
            fi
            
            # systemd ì‚¬ìš©í•˜ëŠ” ê²½ìš° (ê¶Œì¥)
            if systemctl list-units --type=service --all | grep -q discord-bot; then
              echo "ğŸ“¦ systemd ì„œë¹„ìŠ¤ë¡œ ì‹œì‘ ì¤‘..."
              sudo systemctl start discord-bot
              sleep 3
              if systemctl is-active --quiet discord-bot; then
                echo "âœ… systemdë¡œ ë´‡ ì¬ì‹œì‘ ì™„ë£Œ"
                # í”„ë¡œì„¸ìŠ¤ í™•ì¸
                PROC_COUNT=$(pgrep -f "python.*main.py" | wc -l)
                if [ "$PROC_COUNT" -eq 1 ]; then
                  echo "âœ… ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ í™•ì¸ë¨"
                else
                  echo "âš ï¸ ê²½ê³ : í”„ë¡œì„¸ìŠ¤ê°€ $PROC_COUNTê°œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
                fi
              else
                echo "âŒ ë´‡ ì¬ì‹œì‘ ì‹¤íŒ¨. ë¡œê·¸ í™•ì¸: sudo journalctl -u discord-bot -n 50"
                exit 1
              fi
            else
              # ì§ì ‘ ì‹¤í–‰í•˜ëŠ” ê²½ìš° (fallback)
              echo "âš ï¸ systemd ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ì‹¤í–‰ ëª¨ë“œë¡œ ì „í™˜..."
              
              # í”„ë¡œì„¸ìŠ¤ê°€ ì™„ì „íˆ ì¢…ë£Œë˜ì—ˆëŠ”ì§€ ìµœì¢… í™•ì¸
              FINAL_CHECK=$(pgrep -f "python.*main.py" 2>/dev/null || true)
              if [ -n "$FINAL_CHECK" ]; then
                echo "âŒ ì˜¤ë¥˜: ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¢…ë£Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $FINAL_CHECK"
                echo "   ìˆ˜ë™ìœ¼ë¡œ ì¢…ë£Œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”: kill -9 $FINAL_CHECK"
                exit 1
              fi
              
              # ìƒˆ í”„ë¡œì„¸ìŠ¤ ì‹œì‘
              cd "$PROJECT_DIR"
              source venv/bin/activate
              nohup python main.py > bot.log 2>&1 &
              sleep 3
              
              # í”„ë¡œì„¸ìŠ¤ í™•ì¸
              NEW_PIDS=$(pgrep -f "python.*main.py" 2>/dev/null || true)
              if [ -z "$NEW_PIDS" ]; then
                echo "âŒ ë´‡ í”„ë¡œì„¸ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ í™•ì¸: tail -f bot.log"
                exit 1
              fi
              
              PROC_COUNT=$(echo "$NEW_PIDS" | wc -l)
              if [ "$PROC_COUNT" -eq 1 ]; then
                echo "âœ… ë´‡ ì¬ì‹œì‘ ì™„ë£Œ (ì§ì ‘ ì‹¤í–‰, PID: $NEW_PIDS)"
              else
                echo "âš ï¸ ê²½ê³ : í”„ë¡œì„¸ìŠ¤ê°€ $PROC_COUNTê°œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤: $NEW_PIDS"
                echo "   ë¡œê·¸ í™•ì¸: tail -f bot.log"
              fi
            fi
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
          ENDSSH
      
      - name: Deployment Status
        run: |
          echo "âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“‹ ë¡œê·¸ í™•ì¸:"
          echo "  - systemd: ssh ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} 'sudo journalctl -u discord-bot -f'"
          echo "  - ì§ì ‘ ì‹¤í–‰: ssh ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} 'tail -f ~/discord-bot/bot.log'"


name: Deploy Discord Bot to Oracle Cloud

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œí•˜ë©´ ìë™ ë°°í¬
  workflow_dispatch:  # GitHubì—ì„œ ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  deploy:
    name: Deploy to Oracle Cloud
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ORACLE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to Oracle Cloud
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'ENDSSH'
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¤‘ë‹¨
            
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ì´ë™
            PROJECT_DIR="$HOME/discord-bot"
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "âŒ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤: $PROJECT_DIR"
              echo "ì´ˆê¸° ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:"
              echo "  mkdir -p $PROJECT_DIR"
              echo "  cd $PROJECT_DIR"
              echo "  git clone <your-repo-url> ."
              exit 1
            fi
            
            cd "$PROJECT_DIR"
            
            # Git pull
            echo "ğŸ“¥ ì½”ë“œ ì—…ë°ì´íŠ¸ ì¤‘..."
            git fetch origin main
            git reset --hard origin/main || {
              echo "âš ï¸ Git reset ì‹¤íŒ¨, ìˆ˜ë™ í™•ì¸ í•„ìš”"
              exit 1
            }
            
            # ê°€ìƒí™˜ê²½ í™•ì¸ ë° ìƒì„±
            if [ ! -d "venv" ]; then
              echo "ğŸ“¦ ê°€ìƒí™˜ê²½ ìƒì„± ì¤‘..."
              python3 -m venv venv
            fi
            
            # ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            source venv/bin/activate
            pip install --upgrade pip --quiet
            pip install -r requirements.txt --quiet
            
            # ë´‡ ì¬ì‹œì‘
            echo "ğŸ”„ ë´‡ ì¬ì‹œì‘ ì¤‘..."
            
            # systemd ì‚¬ìš©í•˜ëŠ” ê²½ìš° (ê¶Œì¥)
            if systemctl is-active --quiet discord-bot 2>/dev/null; then
              sudo systemctl restart discord-bot
              echo "âœ… systemdë¡œ ë´‡ ì¬ì‹œì‘ ì™„ë£Œ"
              sleep 3
              if systemctl is-active --quiet discord-bot; then
                echo "âœ… ë´‡ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
              else
                echo "âŒ ë´‡ ì¬ì‹œì‘ ì‹¤íŒ¨. ë¡œê·¸ í™•ì¸: sudo journalctl -u discord-bot -n 50"
                exit 1
              fi
            else
              # ì§ì ‘ ì‹¤í–‰í•˜ëŠ” ê²½ìš° (fallback)
              echo "âš ï¸ systemd ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ì‹¤í–‰ ëª¨ë“œë¡œ ì „í™˜..."
              pkill -f "python.*main.py" || true
              sleep 2
              nohup python main.py > bot.log 2>&1 &
              sleep 3
              if pgrep -f "python.*main.py" > /dev/null; then
                echo "âœ… ë´‡ ì¬ì‹œì‘ ì™„ë£Œ (ì§ì ‘ ì‹¤í–‰)"
              else
                echo "âŒ ë´‡ í”„ë¡œì„¸ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ í™•ì¸: tail -f bot.log"
                exit 1
              fi
            fi
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
          ENDSSH
      
      - name: Deployment Status
        run: |
          echo "âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“‹ ë¡œê·¸ í™•ì¸:"
          echo "  - systemd: ssh ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} 'sudo journalctl -u discord-bot -f'"
          echo "  - ì§ì ‘ ì‹¤í–‰: ssh ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} 'tail -f ~/discord-bot/bot.log'"

